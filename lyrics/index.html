<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°„í¸ ê°€ì‚¬ ê²€ìƒ‰ê¸° (LRC LIB)</title>
    <style>
        body {
            font-family: 'Apple SD Gothic Neo', sans-serif;
            background-color: #1e1e1e;
            color: #ffffff;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
        }
        input {
            padding: 10px;
            width: 70%;
            border-radius: 5px;
            border: none;
            font-size: 16px;
        }
        button {
            padding: 10px 20px;
            border-radius: 5px;
            border: none;
            background-color: #007bff;
            color: white;
            font-size: 16px;
            cursor: pointer;
        }
        button:hover { background-color: #0056b3; }
        
        #result-list {
            margin-top: 20px;
            list-style: none;
            padding: 0;
            text-align: left;
        }
        .song-item {
            background-color: #333;
            margin-bottom: 10px;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .song-item:hover { background-color: #444; }
        .song-title { font-weight: bold; font-size: 1.1em; }
        .song-artist { color: #aaa; font-size: 0.9em; }

        #lyrics-container {
            margin-top: 30px;
            text-align: left;
            background-color: #252525;
            padding: 20px;
            border-radius: 10px;
            white-space: pre-wrap;
            line-height: 1.6;
            display: none;
            border: 1px solid #444;
            max-height: 500px;
            overflow-y: auto;
        }
        .time-tag { color: #ffd700; margin-right: 10px; font-size: 0.8em; }

        #control-buttons {
            margin-top: 20px;
            text-align: right;
        }
        #control-buttons button {
            margin-left: 8px;
            padding: 8px 14px;
            font-size: 14px;
        }
    </style>
</head>
<body>

    <h1>ğŸµ ê°€ì‚¬ ê²€ìƒ‰ê¸°</h1>
    <div>
        <input type="text" id="searchInput" placeholder="ë…¸ë˜ ì œëª© ë˜ëŠ” ê°€ìˆ˜ ì…ë ¥ (ì˜ˆ: Butter)">
        <button id="searchBtn">ê²€ìƒ‰</button>
    </div>

    <ul id="result-list"></ul>

    <div id="lyrics-container"></div>

    <script>
        const API_URL = "https://lrclib.net/api/search";

        // í˜„ì¬ ì„ íƒëœ ê³¡ ì •ë³´ë¥¼ ì €ì¥í•  ì „ì—­ ë³€ìˆ˜
        let currentSong = null;
        // ì´ë¯¸ ë–  ìˆëŠ” íŒì—… ì°½ì„ ì¬ì‚¬ìš©í•˜ê¸° ìœ„í•œ ì°¸ì¡°
        let lyricsPopup = null;

        async function searchLyrics() {
            const query = document.getElementById('searchInput').value;
            const resultList = document.getElementById('result-list');
            const lyricsContainer = document.getElementById('lyrics-container');

            if (!query) {
                alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
                return;
            }

            resultList.innerHTML = "<p style='text-align:center; color:#888;'>ê²€ìƒ‰ ì¤‘...</p>";
            lyricsContainer.style.display = 'none';

            try {
                const response = await fetch(`${API_URL}?q=${encodeURIComponent(query)}`);
                const data = await response.json();

                resultList.innerHTML = "";

                if (!data || data.length === 0) {
                    resultList.innerHTML = "<p style='text-align:center;'>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
                    return;
                }

                // ìµœëŒ€ 5ê°œë§Œ í‘œì‹œ
                data.slice(0, 5).forEach(song => {
                    const li = document.createElement('li');
                    li.className = 'song-item';
                    li.innerHTML = `
                        <div class="song-title">â™ª ${song.trackName}</div>
                        <div class="song-artist">${song.artistName} (${song.albumName})</div>
                    `;
                    li.addEventListener('click', () => showLyrics(song));
                    resultList.appendChild(li);
                });

            } catch (error) {
                console.error(error);
                resultList.innerHTML = "<p style='text-align:center; color:red;'>ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>";
            }
        }

        function showLyrics(song) {
            const lyricsContainer = document.getElementById('lyrics-container');
            const resultList = document.getElementById('result-list');

            currentSong = song; // íŒì—…ì—ì„œ ì“°ë ¤ê³  ì €ì¥

            // ê²€ìƒ‰ ê²°ê³¼ ëª©ë¡ ë¹„ìš°ê³  ê°€ì‚¬ ì˜ì—­ í‘œì‹œ
            resultList.innerHTML = "";
            lyricsContainer.style.display = 'block';

            let content = `<h3>${song.trackName} - ${song.artistName}</h3><hr>`;

            if (song.syncedLyrics) {
                // ì‹œê°„ì„ ìƒ‰ì¹ í•´ì„œ ë³´ê¸° ì¢‹ê²Œ
                content += song.syncedLyrics.replace(
                    /\[(\d{2}:\d{2}\.\d{2})\]/g,
                    '<span class="time-tag">[$1]</span>'
                );
            } else if (song.plainLyrics) {
                content += song.plainLyrics;
            } else {
                content += "ê°€ì‚¬ ì •ë³´ê°€ ë“±ë¡ë˜ì§€ ì•Šì€ ê³¡ì…ë‹ˆë‹¤.";
            }

            // ê°€ì‚¬ í…ìŠ¤íŠ¸ + ë²„íŠ¼ ì˜ì—­
            content += `
                <div id="control-buttons">
                    <button id="reSearchBtn" style="background:#555;">ë‹¤ì‹œ ê²€ìƒ‰</button>
                    <button id="popupPlayBtn">ê°€ì‚¬ ì¬ìƒ (íŒì—…)</button>
                </div>
            `;

            lyricsContainer.innerHTML = content;

            // ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°
            document.getElementById('reSearchBtn').addEventListener('click', () => {
                location.reload();
            });

            document.getElementById('popupPlayBtn').addEventListener('click', () => {
                openLyricsPopup();
            });
        }

        function openLyricsPopup() {
            if (!currentSong) {
                alert("ë¨¼ì € ê³¡ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }

            // ì´ë¯¸ íŒì—…ì´ ì—´ë ¤ ìˆê³  ë‹«íˆì§€ ì•Šì•˜ë‹¤ë©´ ì¬ì‚¬ìš©
            if (!lyricsPopup || lyricsPopup.closed) {
                lyricsPopup = window.open(
                    'lyrics-popup.html',      // íŒì—…ì— ë„ìš¸ í˜ì´ì§€ (ê°™ì€ í´ë”ì— ë‘”ë‹¤ê³  ê°€ì •)
                    'lyricsPlayerWindow',
                    'width=500,height=600'
                );
            } else {
                // í¬ì»¤ìŠ¤ë§Œ ë‹¤ì‹œ ì£¼ê¸°
                lyricsPopup.focus();
            }

            if (!lyricsPopup) {
                alert("ë¸Œë¼ìš°ì €ì—ì„œ íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. íŒì—…ì„ í—ˆìš©í•´ì£¼ì„¸ìš”.");
                return;
            }

            // íŒì—…ì´ ë¡œë“œëœ í›„ì— ë°ì´í„° ì „ì†¡
            const sendDataToPopup = () => {
                const payload = {
                    type: 'INIT_LYRICS',
                    payload: {
                        trackName: currentSong.trackName,
                        artistName: currentSong.artistName,
                        syncedLyrics: currentSong.syncedLyrics || null,
                        plainLyrics: currentSong.plainLyrics || null
                    }
                };

                // originì„ ëª…í™•í•˜ê²Œ ì§€ì • (ë³´ì•ˆìƒ ê¶Œì¥)
                const targetOrigin = window.location.origin === 'null'
                    ? '*'   // ë¡œì»¬ íŒŒì¼(file://) í™˜ê²½ì´ë¼ë©´ ì–´ì©” ìˆ˜ ì—†ì´ * ì‚¬ìš©
                    : window.location.origin;

                lyricsPopup.postMessage(payload, targetOrigin);
            };

            // ì´ë¯¸ ë‹¤ ë¡œë”©ëœ ìƒíƒœì¼ ìˆ˜ë„ ìˆê³ , ì•„ë‹ ìˆ˜ë„ ìˆì–´ì„œ ë‘˜ ë‹¤ ì²˜ë¦¬
            try {
                // iOS/Safari ë“± ì¼ë¶€ ë¸Œë¼ìš°ì € í˜¸í™˜ì„ ìœ„í•´ try/catch
                lyricsPopup.onload = () => {
                    sendDataToPopup();
                };
            } catch (e) {
                // onload ì ‘ê·¼ì´ ë§‰íˆë©´ ì•½ê°„ì˜ ì§€ì—° í›„ ì „ì†¡ ì‹œë„
                setTimeout(sendDataToPopup, 500);
            }
        }

        // ê²€ìƒ‰ ë²„íŠ¼ & ì—”í„°í‚¤
        document.getElementById("searchBtn").addEventListener("click", searchLyrics);
        document.getElementById("searchInput").addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                searchLyrics();
            }
        });
    </script>
</body>
</html>